{% extends "raidikalu/base.html" %}
{% load l10n static %}
{% block html_tag_extra %} class="no-js"{% endblock %}

{% block head_extra %}
    <style>
      body {
        display: none;
      }
      .no-js body,
      .js-loaded body {
        display: block;
      }
    </style>
    <style>
      {% for raid_type in editable_settings.raid_types %}
      .pfc[value="{{ raid_type.pokemon }}"]:checked ~ .raid[data-pokemon="{{ raid_type.pokemon }}"] { display: block; }{% endfor %}
      {% for gym in gyms %}
      .gfc[value="{{ gym.name|addslashes }}"]:not(:checked) ~ .raid[data-gym="{{ gym.name|addslashes }}"] { display: none; !important }{% endfor %}
    </style>
    <script>document.documentElement.classList.remove('no-js');</script>
{% endblock %}


{% block main_content %}
    <input id="clipboard-input" class="clipboard-input" tabindex="-1" />

    <div class="new-raid-link-container">
      <a href="{% url 'raidikalu.raid_create' %}" title="Ilmoita raidi" class="new-raid-link">
        <span class="new-raid-link-label">&lt;&mdash; Ilmoita raidi</span>
      </a>
    </div>
    <a href="/" class="refresh-button">
      <i class="fa fa-refresh"></i>
    </a>
    <input class="form-control trainer-nickname-input" value="{{ request.session.nickname }}" placeholder="Nimimerkki, jos haluat erottua" />
    <button class="btn trainer-nickname-btn">OK</button>
    <p>Nää monnit kiinnostais</p>
    {% for raid_type in editable_settings.raid_types %}
    <input id="pf{{ forloop.counter }}" class="fc pfc" data-tier="{{ raid_type.tier }}" type="checkbox" value="{{ raid_type.pokemon }}" checked /><label for="pf{{ forloop.counter }}" class="pft{{ raid_type.tier }} pfl fl">{{ raid_type.pokemon }}</label>{% endfor %}
    <div class="filter-buttons">
      <button class="btn mon js-filter-all">Kaikki käy</button>
      <button class="btn mon js-filter-none">Ei mikään</button>
    </div>

    <p>Nää salit kiinnostais</p>
    {% for gym in gyms %}
    <input id="gf{{ forloop.counter }}" class="gfc fc" type="checkbox" value="{{ gym.name|addslashes }}" checked />
    <label for="gf{{ forloop.counter }}" class="gfl fl">{{ gym.name|addslashes }}</label>
    {% endfor %}
    <div class="filter-buttons">
      <button class="btn gym js-filter-all">Kaikki käy</button>
      <button class="btn gym js-filter-none">Ei mikään</button>
    </div>
  
    <p>Ilmoitukset kiinnostais</p>
    <div>
      <div id="notifications-message"></div>
      <input id="notifications-toggle" class="nfc fc" type="checkbox" />
      <label for="notifications-toggle" class="nfl fl">Ilmoita raideista</label>
    </div>

    {% regroup raids|dictsortreversed:"has_started" by has_started as raids_by_status %}

    {% if raids %}
    {% for grouped_raids in raids_by_status %}
    {% if grouped_raids.grouper %}
    <p>Menossa</p>
    {% else %}
    <p>Tulossa</p>
    {% endif %}
    {% for raid in grouped_raids.list %}
    <div class="raid" data-pokemon="{{ raid.pokemon_name|default:'unknown' }}" data-tier="{{ raid.tier|default:'' }}" data-id="{{ raid.pk }}" data-gym="{{ raid.gym.name|addslashes }}">
      <a name="raidi-{{ raid.pk }}" class="raid-anchor"></a>
      <input id="raid-toggle-{{ raid.pk }}" class="raid-toggle styled-checkable-input" type="checkbox" />
      <div class="raid-main">
        <label for="raid-toggle-{{ raid.pk }}">
          <div class="raid-icon" style="background-image: url({{ raid.gym.image_url }});"></div>
          <div class="raid-pokemon-icon" style="background-image: url({{ raid.get_pokemon_image_url }});"></div>
          <div class="raid-tier">{{ raid.get_tier_display }}</div>
          <div class="raid-pokemon">
            <span>{{ raid.pokemon_name|default:"? ? ?" }}</span>
          </div>
          <div class="raid-time">
            {% if raid.has_started %}
            <span>Päättyy&nbsp;<strong>{{ raid.end_at|date:"H:i" }}</strong>, jäljellä&nbsp;<strong class="raid-time-left" data-time="{{ raid.end_at.timestamp }}">{{ raid.get_time_left_until_end_display }}</strong></span>
            {% elif raid.start_at %}
            <span>Alkaa&nbsp;<strong>{{ raid.start_at|date:"H:i" }}</strong>, alkuun&nbsp;<strong class="raid-time-left" data-time="{{ raid.start_at.timestamp }}">{{ raid.get_time_left_until_start_display }}</strong></span>
            {% else %}
            <span>Kellonaika puuttuu</span>
            {% endif %}
            {% if raid.attendance_count > 0 %}
            <span>, raidaajia&nbsp;<strong>{{ raid.attendance_count }}</strong></span>
            {% endif %}
          </div>
          <div class="raid-name">{{ raid.gym.name }}</div>
        </label>
        <a class="raid-map-link" href="https://gymhuntr.com/#{{ raid.gym.latitude|unlocalize }},{{ raid.gym.longitude|unlocalize }}" target="_blank" rel="noreferrer"><i class="fa fa-map-marker"></i></a>
        <a class="raid-directions-link" href="https://www.google.com/maps/dir/Current+Location/{{ raid.gym.latitude|unlocalize }},{{ raid.gym.longitude|unlocalize }}" target="_blank"><i class="fa fa-car"></i></a>
      </div>
      <div class="raid-extra">
        <div class="raid-details">
          {% if raid.fast_move %}
          <div class="raid-detail">Liikkeet: <strong>{{ raid.fast_move|default:"- - -" }} / {{ raid.charge_move|default:"- - -" }}</strong></div>
          {% endif %}
          {% if raid.gym.is_park %}
          <div class="raid-detail">Puisto: <strong>todennäköisesti</strong></div>
          {% endif %}
          {% if raid.submitter %}
          <div class="raid-detail">Ilmoittaja: <strong>{{ raid.submitter }}</strong></div>
          {% elif not raid.submitter and not raid.data_source_id %}
          <div class="raid-detail">Ilmoittaja: <strong>Anonyymi</strong></div>
          {% endif %}
          {% if raid.unverified_text %}
          <div class="raid-detail">Vahvistamatta: <strong>{{ raid.unverified_text }}</strong></div>
          {% endif %}
        </div>
        {% if raid.start_at %}
        <div class="raider-attendance-choices" data-raid-id="{{ raid.pk }}">
          <div>Haluun raidata klo</div>
          {% for start_time in raid.start_times_with_attendances %}
          <input id="rac-{{ raid.pk }}-{{ forloop.counter0 }}" class="raid-attendance-choice styled-checkable-input" type="radio" name="rac-{{ raid.pk }}" value="{{ forloop.counter0 }}"{% if raid.own_start_time_choice == forloop.counter0 %} checked{% endif %} />
          <label for="rac-{{ raid.pk }}-{{ forloop.counter0 }}" class="btn">{{ start_time.time|date:"H:i" }} (<span class="rac-{{ forloop.counter0 }}-count">{{ start_time.attendances|length }}</span>)</label>
          {% endfor %}
          <input id="rac-{{ raid.pk }}-cancel" class="styled-checkable-input raid-attandance-cancel" type="radio" name="rac-{{ raid.pk }}" value="cancel"{% if raid.own_start_time_choice == None %} checked{% endif %} />
          <label for="rac-{{ raid.pk }}-cancel" class="btn">Enpäs raidaakaan!</label>
        </div>
        {% for start_time in raid.start_times_with_attendances %}
        {% if start_time.attendances %}
        <div class="raid-attendees">
          <div class="raid-attendee"><strong>{{ start_time.time|date:"H:i" }}</strong></div>
          {% for attendance in start_time.attendances %}
          <div class="raid-attendee">- {{ attendance.submitter }}</div>
          {% endfor %}
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
        <div class="sharing-links">
          <span>Linkkaa </span>
          <a href="whatsapp://send?text={% filter urlencode:'' %}{{ BASE_URL }}#raidi-{{ raid.pk }} {% endfilter %}" target="_blank">WhatsAppiin</a>
          <span>, </span>
          <a href="tg://msg_url?url={% filter urlencode:'' %}{{ BASE_URL }}#raidi-{{ raid.pk }} {% endfilter %}" target="_blank">Telegramiin</a>
          <span> tai kopioi </span>
          <a href="{% filter addslashes %}{{ BASE_URL }}#raidi-{{ raid.pk }}{% endfilter %}">linkki</a>
          <span>.</span>
        </div>
      </div>
    </div>
    {% endfor %}
    {% endfor %}
    {% else %}
    {% if editable_settings.additional_information %}
    <p>Ei yhtäkään raidia, mutta nyt on hyvä aika tsekata mitä alalaidasta löytyy.</p>
    {% else %}
    <p>Ei yhtäkään raidia</p>
    {% endif %}
    {% endif %}


    {% if editable_settings.additional_information %}
    <div class="additional-information">
      {{ editable_settings.additional_information|safe }}
    </div>
    {% endif %}
    
    <script>
      var CSRFTOKEN = '{{ csrf_token|addslashes }}';
      var NICKNAME = '{{ request_nickname }}';
    </script>
    <script>
      (function persistPokemonAndGymFilters() {

        if ( ! window.localStorage) {
          return;
        }

        var SELECTED_POKEMON_KEY = 'selected-pokemon-v{{ editable_settings.expires_at|date:"YmdHi" }}';
        var SELECTED_GYMS_KEY = 'selected-gyms-v{{ editable_settings.expires_at|date:"YmdHi" }}';

        var selectedPokemonData = localStorage.getItem(SELECTED_POKEMON_KEY) || '[{% for raid_type in editable_settings.raid_types %}"{{ raid_type.pokemon }}"{% if not forloop.last %},{% endif %}{% endfor %}]';
        var selectedPokemon = JSON.parse(selectedPokemonData) || [];

        Array.prototype.slice.call(document.querySelectorAll('.pfc')).forEach(initFilters(selectedPokemon));

        var selectedTiers = [];

        function updateTiers() {
          selectedTiers.splice(0, selectedTiers.length);
          for (var tier = 1; tier <= 5; ++tier) {
            var tierEnabled = document.querySelector('.pfc[data-tier="' + tier + '"]:checked') !== null;
            if (tierEnabled) {
              selectedTiers.push(tier);
            }
          }
        }
	updateTiers();

        var selectedGymsData = localStorage.getItem(SELECTED_GYMS_KEY) || '[{% for gym in gyms %}"{{ gym.pk }}"{% if not forloop.last %},{% endif %}{% endfor %}]';
        var selectedGyms = JSON.parse(selectedGymsData) || [];

        Array.prototype.slice.call(document.querySelectorAll('.gfc')).forEach(initFilters(selectedGyms));

        document.addEventListener('change', handlePokemonGymFilterChange);
        document.documentElement.classList.add('js-loaded');

        function initFilters(selectedValues) {
          function initFilter(filterCheckbox) {
            var value = filterCheckbox.value;
            if (selectedValues.indexOf(value) === -1) {
              filterCheckbox.checked = false;
            }
          }
          return initFilter;
        }

        function handlePokemonGymFilterChange(event) {
          var checkbox = event.target;
          if (checkbox.classList.contains('pfc')) {
            persistFilter(checkbox, selectedPokemon, SELECTED_POKEMON_KEY);
	    updateTiers();
          } else if (checkbox.classList.contains('gfc')) {
            persistFilter(checkbox, selectedGyms, SELECTED_GYMS_KEY);
          }
        }

        function persistFilter(checkbox, selectedValues, STORAGE_KEY) {

          var value = checkbox.value;
          var indexOfValue = selectedValues.indexOf(value);

          if (checkbox.checked && indexOfValue === -1) {
            selectedValues.push(value);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(selectedValues));
          }
          if ( ! checkbox.checked && indexOfValue !== -1) {
            selectedValues.splice(indexOfValue, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(selectedValues));
          }

        }

        createAllNoneListeners('.mon.js-filter-all', '.mon.js-filter-none', '.pfc', selectedPokemon, SELECTED_POKEMON_KEY)
        createAllNoneListeners('.gym.js-filter-all', '.gym.js-filter-none', '.gfc', selectedGyms, SELECTED_GYMS_KEY)

        function createAllNoneListeners(allSelector, noneSelector, inputSelector, selectedList, KEY) {
          var allButton = document.querySelector(allSelector);
          var noneButton = document.querySelector(noneSelector);
          var filterCheckboxes = Array.prototype.slice.call(document.querySelectorAll(inputSelector));

          allButton.addEventListener('click', function setFilterAll() {
            filterCheckboxes.forEach(function check(checkbox) {
              checkbox.checked = true;
              persistFilter(checkbox, selectedList, KEY);
            });
          });

          noneButton.addEventListener('click', function setFilterNone() {
            filterCheckboxes.forEach(function uncheck(checkbox) {
              checkbox.checked = false;
              persistFilter(checkbox, selectedList, KEY);
            });
          });
        }

	window.selectedPokemon = selectedPokemon;
	window.selectedGyms = selectedGyms;
	window.selectedTiers = selectedTiers;
      })();
    </script>
    <script>
      document.documentElement.classList.add('js-loaded');
      window.serviceWorkerUrl = "{% static 'raidikalu/js/serviceworker.js' %}";
      window.applicationServerKey = "{{ application_server_key }}";
    </script>
    <script src="{% static 'raidikalu/js/raid-list.js' %}" defer></script>
    <script src="{% static 'raidikalu/js/reconnecting-websocket.min.js' %}" defer onload="initMessageListeners()"></script>
    <script src="{% static 'raidikalu/js/notifications.js' %}" defer></script>
{% endblock %}
